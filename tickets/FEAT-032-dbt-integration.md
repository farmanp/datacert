# FEAT-032: dbt Integration

## 1. Intent (Required)

**User Story:**
As a dbt user
I want to profile my dbt model outputs directly
So that I can validate data quality as part of my dbt workflow

**Success Looks Like:**
`datacert profile --dbt-model customers` profiles the output of `customers` model from local warehouse, or export dbt-compatible tests from a profile.

## 2. Context & Constraints (Required)

**Background:**
dbt is the industry standard for data transformation. Integration points:
1. **Profile model outputs** - After `dbt run`, profile the resulting table
2. **Generate dbt tests** - Export profile as dbt schema tests
3. **dbt artifacts** - Read manifest.json to understand models
4. **Pre-commit hook** - Profile before committing model changes

This positions DataCert as a dbt companion tool, not competitor.

**Scope:**
- **In Scope:**
  - Export profile as dbt schema.yml tests
  - Parse dbt manifest.json to list models
  - CLI: `datacert profile --dbt-model <model>`
  - Generate `not_null`, `unique`, `accepted_values`, `relationships` tests
  - Support tolerance thresholds for test generation

- **Out of Scope:**
  - Direct warehouse connection (use dbt to export)
  - dbt Cloud API integration
  - Running dbt commands
  - dbt-core package/adapter

**Constraints:**
- Must work with dbt-core (open source)
- No warehouse credentials in DataCert
- Works with exported data (CSV/Parquet from warehouse)

## 3. Acceptance Criteria (Required)

**Scenario: Export dbt tests**
Given I have profiled a CSV file "customers.csv"
When I click "Export" â†’ "dbt Tests (YAML)"
Then a schema.yml file is generated with tests
And tests include `not_null`, `unique`, `accepted_values` based on profile

**Scenario: Parse dbt manifest**
Given a dbt project with manifest.json
When I run `datacert list-models --manifest target/manifest.json`
Then all model names are listed
And I can select a model to profile

**Scenario: Generate accepted_values test**
Given a column "status" has top values ["active", "inactive", "pending"]
When I export dbt tests
Then the output includes:
```yaml
- name: status
  tests:
    - accepted_values:
        values: ['active', 'inactive', 'pending']
```

**Scenario: Generate numeric range test**
Given a column "amount" has min=0 and max=10000
When I export dbt tests with 10% tolerance
Then the output includes:
```yaml
- name: amount
  tests:
    - dbt_utils.accepted_range:
        min_value: -1000  # 0 - 10%
        max_value: 11000  # 10000 + 10%
```

**Scenario: Unique column detection**
Given a column "id" has 100% distinct values
When I export dbt tests
Then the output includes `unique` test for that column

## 4. AI Execution Instructions (Required)

**Allowed to Change:**
- Create `src/app/utils/exportDbtTests.ts`
- Add dbt export option to ProfileReport
- Create `src/cli/commands/dbt.ts` for CLI integration
- Create documentation for dbt workflow

**Must NOT Change:**
- Profile computation
- Other export formats
- Core WASM logic

**Ambiguity Rule:**
If unclear, acceptance criteria override all other sections.

## 5. Planned Git Commit Message(s) (Required)

- feat(dbt): add dbt schema.yml test export
- feat(dbt): generate not_null and unique tests
- feat(dbt): generate accepted_values from top values
- feat(dbt): add numeric range tests with tolerance
- feat(cli): add dbt manifest parsing
- docs: add dbt integration guide

## 6. Verification & Definition of Done (Required)

- [ ] Export produces valid dbt schema.yml
- [ ] `not_null` tests for columns with 100% completeness
- [ ] `unique` tests for columns with 100% distinct
- [ ] `accepted_values` for low-cardinality columns
- [ ] Numeric range tests with configurable tolerance
- [ ] schema.yml validates with `dbt compile`
- [ ] Documentation with example workflow

## 7. Technical Design

### Output Format (schema.yml)

```yaml
version: 2

models:
  - name: customers
    description: "Generated by DataCert"
    columns:
      - name: id
        description: "Integer column, 100% complete"
        tests:
          - not_null
          - unique

      - name: email
        description: "String column, 99.5% complete"
        tests:
          - not_null:
              config:
                where: "email is not null"  # 0.5% allowed null

      - name: status
        description: "Categorical with 3 unique values"
        tests:
          - accepted_values:
              values: ['active', 'inactive', 'pending']

      - name: amount
        description: "Numeric, range 0-10000"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 11000
              inclusive: true
```

### Test Generation Logic

```typescript
function generateDbtTests(profile: ProfileResult, options: DbtExportOptions): DbtSchema {
  const columns = profile.column_profiles.map(col => {
    const tests: DbtTest[] = [];

    // Not null test
    if (col.base_stats.missing === 0) {
      tests.push({ name: 'not_null' });
    } else if (col.base_stats.missing / col.base_stats.count < 0.01) {
      // Allow small percentage with config
      tests.push({
        name: 'not_null',
        config: { severity: 'warn' }
      });
    }

    // Unique test
    const distinctRatio = col.base_stats.distinct_estimate / col.base_stats.count;
    if (distinctRatio > 0.99) {
      tests.push({ name: 'unique' });
    }

    // Accepted values (low cardinality)
    if (col.categorical_stats && col.categorical_stats.unique_count < 20) {
      tests.push({
        name: 'accepted_values',
        values: col.categorical_stats.top_values.map(tv => tv.value)
      });
    }

    // Numeric range
    if (col.numeric_stats) {
      const tolerance = options.tolerance / 100;
      const range = col.numeric_stats.max - col.numeric_stats.min;
      tests.push({
        name: 'dbt_utils.accepted_range',
        min_value: col.numeric_stats.min - (range * tolerance),
        max_value: col.numeric_stats.max + (range * tolerance)
      });
    }

    return { name: col.name, tests };
  });

  return { version: 2, models: [{ name: options.modelName, columns }] };
}
```

### CLI Usage

```bash
# Export from profiled file
datacert profile customers.csv --export dbt --model customers > models/schema.yml

# List dbt models from manifest
datacert dbt list-models --manifest target/manifest.json

# Profile specific model output (requires export from warehouse)
datacert dbt profile --model customers --manifest target/manifest.json
```

## 8. Resources

- [dbt schema.yml spec](https://docs.getdbt.com/reference/resource-properties/columns)
- [dbt-utils package](https://hub.getdbt.com/dbt-labs/dbt_utils/latest/)
- [dbt manifest.json](https://docs.getdbt.com/reference/artifacts/manifest-json)
